---
layout: post
title: "Jekyll 블로그 EC2 자동화 파이프라인 구축 로그"
date: 2025-09-25
categories: [Learning]
tags: [aws, ec2, ubuntu, jekyll, python, automation, devops]
description: "EC2에서 Jekyll 블로그 자동 발행 파이프라인을 구축하고 운영한 전체 과정 기술 메모"
---

## 개요
오늘은 **AWS EC2(Ubuntu 24.04)** 위에서 Jekyll 블로그 저장소에 대해 Python 기반 **콘텐츠 생성 스케줄러**를 구동하고, 관련 운영 이슈(가상환경, 의존성, 백그라운드 실행, 프로세스 관리)를 해결했다. 주요 작업과 장애/해결 내역을 **재현 가능한 순서**로 정리한다.

---

## 환경 정보
- OS: Ubuntu 24.04.3 LTS (`GNU/Linux 6.14.0-1011-aws x86_64`)
- 프로젝트 루트: `~/myblog`
- 주요 파일/디렉터리:  
  `article_generator.py`, `scheduler.py`, `_posts/`, `_config.yml`, `Gemfile`, `topics.json`
- 접속: SSH (`-i C:\pem\my_proton_key.pem -p 2222 ubuntu@13.125.184.105`)
- 현지 시간대: Asia/Seoul (UTC+9)

---

## 타임라인 및 실행 로그

### 1) 초기 확인 및 가상환경 생성 실패
```bash
cd ~/myblog
python3 -m venv venv
# ensurepip 미탑재로 venv 생성 실패 → python3.12-venv 필요
```

오류 메시지에서 제시한 대로 `python3.12-venv` 패키지가 필요했으나, 일반 사용자 권한으로 설치를 시도해 **lock 파일 권한 오류**가 발생.

```bash
apt install python3.12-venv
# E: Permission denied → sudo 필요
```

### 2) 재접속 후 venv 패키지 설치 및 가상환경 구성

```bash
sudo apt install python3.12-venv
python3 -m venv venv
source venv/bin/activate
pip install requests
```

* `python3-pip-whl`, `python3-setuptools-whl`가 함께 설치되며 pip 사용 가능.
* 커널 업데이트 알림 존재 → **재부팅 권고** 메시지 확인(즉시 재부팅은 보류).

### 3) 토픽 파일 점검 및 스케줄러 실행

```bash
vi topics.json
python3 scheduler.py
```

스케줄러가 순차적으로 포스트를 생성·커밋·푸시. 일부 샘플:

> 성공적으로 '집에서 즐기는 DIY 향초 만들기'에 대한 글을 작성하고 푸시했습니다.
> 출력: `[main 2c4198e] 새 글 작성함`
> `1 file changed, 1 deletion(-)` 등

* 다수의 주제가 `_posts/`에 생성되며 커밋 해시가 출력됨.
* 중간에 \*\*`Ctrl + C`\*\*로 수동 인터럽트(`KeyboardInterrupt`) 2회 수행하여 배치 반복을 중단.

### 4) 백그라운드 실행 전환

오타 교정 과정(`nohub` → `nohup`) 후 백그라운드 구동:

```bash
nohup python3 scheduler.py &
# nohup.out 로깅
```

### 5) 프로세스 모니터링 및 종료

```bash
ps aux | grep scheduler.py
kill -9 <PID>
```

* 정상적으로 데몬화된 프로세스를 확인 후, 필요 시 **강제 종료(-9)** 수행.

### 6) 시스템 전원 차단

마지막으로 원격 메시지에 따라 **시스템 종료 브로드캐스트** 수신 후 세션 종료됨.

---

## 트러블슈팅 노트

### A. `ensurepip` 부재로 venv 실패

* **원인**: 미니멀 Python 설치에서 `ensurepip`가 포함되지 않아 `venv` 초기화 실패.
* **해결**: `sudo apt install python3.12-venv` 후 재시도.
* **교훈**: Ubuntu 24.04 + Python 3.12 환경에서는 **`python3.12-venv` 선설치**를 설치 스크립트에 포함할 것.

### B. 패키지 락 권한 오류

* **증상**: `/var/lib/dpkg/lock-frontend` 권한 문제.
* **해결**: `sudo` 사용.
* **Best Practice**: CI/CD 또는 부팅 초기화 스크립트에 루트 권한 전제 단계(필요 패키지 설치)를 별도 태스크로 분리.

### C. 장기 실행 스크립트의 세션 종속성

* **이슈**: 포그라운드에서 실행 시 SSH 끊기면 프로세스 종료 위험.
* **해결**: `nohup ... &`로 세션 비종속 백그라운드화.
  운영 관점에서는 `systemd` 유닛으로 전환 권장(자동 재시작/로깅 표준화).

### D. 커널 업데이트 알림

* **상태**: `needrestart`에서 커널 버전 상이 메시지 출력.
* **조치**: 가용성 고려하여 **예약 재부팅** 절차 수립 필요.

---

## 산출물(예시)

* `_posts/2025-09-25-diy-guide-and-tips.md` (로그상 생성 확인)
* 그 외 다수의 자동 생성 포스트(과학/환경/여행/커리어/리뷰 등 주제)

---

## 운영 체크리스트 (재현용)

1. **의존성 사전 설치**

   * `sudo apt update && sudo apt install -y python3.12-venv`
2. **가상환경**

   * `python3 -m venv venv && source venv/bin/activate`
   * `pip install -U pip && pip install requests`
3. **설정/데이터**

   * `topics.json` 점검(UTF-8, 주제 중복/금칙어 확인)
4. **스케줄러 구동**

   * 포그라운드 검증: `python3 scheduler.py`
   * 백그라운드 전환: `nohup python3 scheduler.py &`
5. **모니터링/로그**

   * `tail -f nohup.out`
   * `ps aux | grep scheduler.py`
6. **종료/정리**

   * `kill -15 <PID>` → 필요 시 `kill -9 <PID>`
7. **유지보수**

   * 커널 업데이트 후 **예약 재부팅**(운영 공지)
   * `systemd` 서비스 전환 고려(아래 참조)

---

## 운영 고도화 제안

### 1) `systemd` 서비스로 전환

`/etc/systemd/system/blog-scheduler.service`:

```ini
[Unit]
Description=Jekyll Article Scheduler
After=network-online.target

[Service]
User=ubuntu
WorkingDirectory=/home/ubuntu/myblog
Environment="PATH=/home/ubuntu/myblog/venv/bin:/usr/bin"
ExecStart=/home/ubuntu/myblog/venv/bin/python /home/ubuntu/myblog/scheduler.py
Restart=always
RestartSec=5
StandardOutput=append:/home/ubuntu/myblog/scheduler.log
StandardError=append:/home/ubuntu/myblog/scheduler.err

[Install]
WantedBy=multi-user.target
```

적용:

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now blog-scheduler.service
sudo systemctl status blog-scheduler.service
```

### 2) 실패 방지 가드레일

* **Git 실패 처리**: 푸시 실패 시 재시도(backoff), 네트워크 예외 로깅.
* **중복 생성 방지**: `_posts/` 파일명 충돌 체크(날짜+슬러그 유니크 보장).
* **토픽 소진/편향 방지**: `topics.json` 소비 전략(라운드로빈/가중치/금칙어).
* **관측성**: `structured logging(JSON)`, 일일 리포트 Slack/Webhook.

### 3) 안전한 중단/재시작

* SIGTERM 핸들러를 `scheduler.py`에 구현하여 **그레이스풀 셧다운**(in-flight 작업 완료 후 종료).

---

## 회고 (Lessons Learned)

* **Python venv는 OS별 패키지 준비가 관건**: `ensurepip` 부재는 흔한 함정.
* **운영은 “세션 비종속”이 기본값**: `nohup`/`systemd`를 통해 안정적으로 장기 실행.
* **커널 업데이트는 계획된 재부팅**으로 처리: 새 커널 반영과 보안 패치 준수.

---

## 후속 액션

* [ ] `systemd` 전환 및 로테이션 로그 적용
* [ ] 재부팅 윈도우 잡고 커널 업데이트 반영
* [ ] `scheduler.py`에 예외/재시도/중복방지 로직 강화
* [ ] 주제 품질 관리 파이프라인 도입(금칙어·중복 필터)

---

## 부록: 오늘 사용한 주요 명령어 스니펫

```bash
# venv 준비
sudo apt install -y python3.12-venv
python3 -m venv venv
source venv/bin/activate
pip install requests

# 스케줄러 실행/중단
python3 scheduler.py
nohup python3 scheduler.py &
ps aux | grep scheduler.py
kill -9 <PID>
```

---

*메모*: 본 문서는 셸 출력 로그를 기반으로 작성되었으며, 운영 명령어/옵션은 환경에 따라 조정될 수 있다.

