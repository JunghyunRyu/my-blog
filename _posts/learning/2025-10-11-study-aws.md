---
title: "AWS EC2 FastAPI 프로덕션 배포 완전 가이드"
date: 2025-10-11 10:30:00
categories: [Learning]
tags: [FastAPI, EC2, Ubuntu, systemd, Python, 서버배포, 자동실행, SFTP, Nginx, HTTPS, Security, DevOps, Backend]
description: "AWS EC2 Ubuntu 환경에서 FastAPI 애플리케이션을 프로덕션 수준으로 배포하는 완전한 기술 레퍼런스. systemd 자동 실행, Nginx 리버스 프록시, HTTPS 설정, 보안 강화, 성능 최적화, 모니터링까지 포함."
author: "DevOps Engineer"
toc: true
---

# AWS EC2 FastAPI 프로덕션 배포 완전 가이드

## 개요

본 문서는 AWS EC2 Ubuntu 환경에서 FastAPI 애플리케이션을 프로덕션 수준으로 배포하기 위한 종합적인 기술 레퍼런스입니다.

기본적인 서버 구축부터 시작하여, systemd를 통한 프로세스 관리, Nginx 리버스 프록시 구성, HTTPS 인증서 설정, 보안 강화, 성능 최적화, 모니터링 및 로깅까지 프로덕션 환경에 필요한 모든 측면을 다룹니다.

**주요 다루는 내용:**

- EC2 인스턴스 설정 및 네트워크 보안 구성
- Python 가상환경 및 FastAPI 애플리케이션 구성
- systemd를 통한 서비스 자동화 및 프로세스 관리
- Nginx 리버스 프록시 설정 및 최적화
- Let's Encrypt를 통한 무료 SSL/TLS 인증서 발급
- UFW 방화벽 및 Fail2ban을 통한 보안 강화
- 로그 관리, 디버깅 및 트러블슈팅
- 성능 최적화 및 모니터링 전략

---

## 목차

1. [사전 요구사항](#사전-요구사항)
2. [환경 준비](#환경-준비)
3. [Python 및 필수 패키지 설치](#python-및-필수-패키지-설치)
4. [프로젝트 디렉터리 구성](#프로젝트-디렉터리-구성)
5. [가상환경 구성 및 FastAPI 설치](#가상환경-구성-및-fastapi-설치)
6. [FastAPI 애플리케이션 코드](#fastapi-애플리케이션-코드)
7. [서버 실행 테스트](#서버-실행-테스트)
8. [AWS 보안 그룹 설정](#aws-보안-그룹-설정)
9. [systemd를 통한 자동 실행 설정](#systemd를-통한-자동-실행-설정)
10. [환경 변수 관리](#환경-변수-관리)
11. [로그 관리 및 디버깅](#로그-관리-및-디버깅)
12. [Nginx 리버스 프록시 설정](#nginx-리버스-프록시-설정)
13. [HTTPS 설정 (Let's Encrypt)](#https-설정-lets-encrypt)
14. [보안 강화](#보안-강화)
15. [성능 최적화](#성능-최적화)
16. [모니터링 및 유지보수](#모니터링-및-유지보수)
17. [VSCode SFTP 설정](#vscode-sftp-설정)
18. [트러블슈팅](#트러블슈팅)
19. [참고 자료](#참고-자료)

---

## 사전 요구사항

### 시스템 요구사항

**AWS 리소스:**
- EC2 인스턴스 (최소 t2.micro, 권장 t2.small 이상)
- 탄력적 IP 주소 (Elastic IP) - 프로덕션 환경 권장
- 보안 그룹 설정 권한

**로컬 환경:**
- SSH 클라이언트 (Windows: PowerShell/PuTTY, macOS/Linux: 터미널)
- PEM 키 파일
- VSCode (선택사항, 배포 자동화용)

**소프트웨어 버전:**
- Ubuntu 24.04.2 LTS (또는 22.04 LTS)
- Python 3.10 이상 (권장: 3.11+)
- FastAPI 0.100.0 이상
- Uvicorn 0.23.0 이상
- Nginx 1.18.0 이상 (리버스 프록시 사용 시)

**네트워크 지식:**
- TCP/IP 기본 개념
- HTTP/HTTPS 프로토콜
- DNS 기본 개념 (도메인 사용 시)

**보안 지식:**
- SSH 키 기반 인증
- 방화벽 기본 개념
- SSL/TLS 인증서 개념

### 아키텍처 개요

프로덕션 환경에서의 FastAPI 배포 아키텍처:

```
인터넷
  ↓
[AWS 보안 그룹] → 포트 80, 443 허용
  ↓
[Nginx 리버스 프록시] → 포트 80/443
  ↓
[Uvicorn (FastAPI)] → 포트 8000 (로컬)
  ↓
[systemd] → 프로세스 관리 및 자동 재시작
```

**주요 구성 요소:**
- **Nginx**: 정적 파일 서빙, SSL 종료, 로드 밸런싱, 보안 헤더
- **Uvicorn**: ASGI 서버, FastAPI 애플리케이션 실행
- **systemd**: 서비스 자동 시작, 재시작, 로그 관리
- **UFW**: 호스트 기반 방화벽
- **Let's Encrypt**: 무료 SSL/TLS 인증서

---

## 환경 준비

### EC2 인스턴스 생성

**인스턴스 스펙 선택:**

```
AMI: Ubuntu Server 24.04.2 LTS (HVM), SSD Volume Type
인스턴스 유형: t2.micro (프리티어) 또는 t2.small (권장)
스토리지: 최소 8GB (권장 20GB 이상)
```

**인스턴스 생성 과정:**

1. AWS Console → EC2 → 인스턴스 시작
2. Ubuntu 24.04.2 LTS AMI 선택
3. 인스턴스 유형 선택 (CPU, 메모리 고려)
4. 키 페어 생성/선택 (.pem 파일 다운로드 및 안전하게 보관)
5. 네트워크 설정 - 나중에 보안 그룹 구성
6. 스토리지 구성 - 최소 8GB gp3 볼륨
7. 고급 세부 정보 - IAM 역할 필요 시 설정

**Elastic IP 할당 (프로덕션 권장):**

고정 IP 주소가 필요한 경우:

```bash
# AWS Console에서
EC2 → 탄력적 IP → 주소 할당 → 인스턴스에 연결
```

이를 통해 인스턴스 재시작 시에도 동일한 IP 주소를 유지할 수 있습니다.

### EC2 인스턴스 접속

**SSH 키 권한 설정 (최초 1회):**

```bash
# Linux/macOS
chmod 400 /경로/열쇠파일.pem

# Windows PowerShell
icacls "C:\경로\열쇠파일.pem" /inheritance:r
icacls "C:\경로\열쇠파일.pem" /grant:r "%USERNAME%:R"
```

**SSH 접속:**

```bash
ssh -i /경로/열쇠파일.pem ubuntu@인스턴스IP

# 예시 (Linux/macOS)
ssh -i /Users/pem/my_proton_key.pem ubuntu@13.124.216.216

# 예시 (Windows)
ssh -i C:\Users\my\pem\my_proton_key.pem ubuntu@13.124.216.216
```

**SSH 접속 간소화 (.ssh/config 설정):**

로컬 머신의 `~/.ssh/config` 파일에 다음 내용 추가:

```
Host aws-fastapi
    HostName 13.124.216.216
    User ubuntu
    IdentityFile /경로/열쇠파일.pem
    ServerAliveInterval 60
```

이제 `ssh aws-fastapi`만으로 접속 가능합니다.

### 초기 시스템 업데이트

인스턴스 접속 후 시스템 업데이트를 진행합니다:

```bash
sudo apt update
sudo apt upgrade -y
sudo apt autoremove -y
```

**시스템 시간대 설정:**

```bash
# 현재 시간대 확인
timedatectl

# 서울 시간대로 설정
sudo timedatectl set-timezone Asia/Seoul

# 확인
timedatectl
```

---

## Python 및 필수 패키지 설치

### Python 설치 및 버전 확인

Ubuntu 24.04 LTS는 Python 3.12가 기본 설치되어 있습니다:

```bash
# Python 버전 확인
python3 --version

# 출력 예: Python 3.12.3
```

### 필수 개발 도구 설치

```bash
sudo apt install -y \
    python3 \
    python3-venv \
    python3-pip \
    python3-dev \
    build-essential \
    libssl-dev \
    libffi-dev \
    git \
    curl \
    wget
```

**패키지 설명:**
- `python3-venv`: 가상환경 생성 도구
- `python3-pip`: Python 패키지 관리자
- `python3-dev`: Python C 확장 컴파일용 헤더
- `build-essential`: C/C++ 컴파일러 및 make
- `libssl-dev`, `libffi-dev`: 암호화 라이브러리 의존성
- `git`: 버전 관리 (코드 배포 시 유용)
- `curl`, `wget`: HTTP 클라이언트 도구

### pip 업그레이드

```bash
python3 -m pip install --upgrade pip
```

---

## 프로젝트 디렉터리 구성

### 디렉터리 생성

```bash
cd ~
mkdir -p reactbase/public
cd reactbase
```

### 프로젝트 구조

프로덕션 환경에서 권장하는 디렉터리 구조:

```
/home/ubuntu/reactbase/
├── venv/                # 가상환경
├── server.py            # FastAPI 애플리케이션
├── .env                 # 환경 변수 (민감 정보)
├── requirements.txt     # Python 의존성
├── public/              # 정적 파일 (이미지, CSS, JS 등)
│   ├── images/
│   ├── css/
│   └── js/
├── logs/                # 애플리케이션 로그 (선택사항)
└── tests/               # 테스트 코드 (선택사항)
```

### 디렉터리 권한 설정

```bash
# 현재 사용자 소유로 설정
sudo chown -R ubuntu:ubuntu /home/ubuntu/reactbase

# 디렉터리 권한 설정 (755)
chmod 755 /home/ubuntu/reactbase

# 정적 파일 디렉터리
chmod 755 /home/ubuntu/reactbase/public
```

---

## 가상환경 구성 및 FastAPI 설치

### 가상환경 생성 및 활성화

```bash
# 가상환경 생성
python3 -m venv venv

# 가상환경 활성화
source venv/bin/activate

# 활성화 확인 - 프롬프트 앞에 (venv) 표시
(venv) ubuntu@ip-xxx:~/reactbase$
```

**가상환경 사용 이유:**
- 시스템 Python과 프로젝트 의존성 분리
- 프로젝트별 독립적인 패키지 버전 관리
- 권한 문제 방지 (sudo 없이 패키지 설치 가능)

### FastAPI 및 필수 패키지 설치

```bash
# 기본 패키지 설치
pip install fastapi uvicorn[standard]

# 추가 유용한 패키지
pip install \
    python-dotenv \
    pydantic[email] \
    python-multipart \
    aiofiles
```

**패키지 설명:**
- `fastapi`: 웹 프레임워크
- `uvicorn[standard]`: ASGI 서버 (HTTP/WebSocket 지원, 성능 최적화 포함)
- `python-dotenv`: .env 파일에서 환경 변수 로드
- `pydantic[email]`: 데이터 검증 (이메일 검증 포함)
- `python-multipart`: 파일 업로드 지원
- `aiofiles`: 비동기 파일 I/O

### requirements.txt 생성

의존성 관리를 위해 설치된 패키지 목록을 저장:

```bash
pip freeze > requirements.txt
```

**requirements.txt 내용 예시:**

```
fastapi==0.109.0
uvicorn[standard]==0.27.0
python-dotenv==1.0.0
pydantic[email]==2.5.0
python-multipart==0.0.6
aiofiles==23.2.1
```

### 가상환경 비활성화

작업 완료 후 가상환경 종료:

```bash
deactivate
```

---

## FastAPI 애플리케이션 코드

### 기본 server.py

`/home/ubuntu/reactbase/server.py` 파일 생성:

```python
from fastapi import FastAPI, Request
from fastapi.responses import PlainTextResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
import uvicorn
import pathlib
import os
from datetime import datetime

# 환경 변수 로드 (선택사항)
from dotenv import load_dotenv
load_dotenv()

# FastAPI 앱 초기화
app = FastAPI(
    title="FastAPI Production Server",
    description="AWS EC2에 배포된 프로덕션 FastAPI 서버",
    version="1.0.0",
    docs_url="/docs",  # Swagger UI
    redoc_url="/redoc"  # ReDoc
)

# CORS 설정 (필요한 경우)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 프로덕션에서는 특정 도메인만 허용
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 신뢰할 수 있는 호스트 설정 (보안)
# app.add_middleware(
#     TrustedHostMiddleware,
#     allowed_hosts=["yourdomain.com", "www.yourdomain.com"]
# )

# 헬스 체크 엔드포인트
@app.get("/health", response_class=JSONResponse)
async def health_check():
    """서버 상태 확인용 헬스 체크 엔드포인트"""
    return {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "version": "1.0.0"
    }

# 기본 엔드포인트
@app.get("/", response_class=PlainTextResponse)
async def read_root():
    """루트 경로"""
    return "Welcome to FastAPI Production Server"

@app.get("/hello", response_class=PlainTextResponse)
async def read_hello():
    """Hello 엔드포인트"""
    return "hello"

@app.get("/world", response_class=PlainTextResponse)
async def read_world():
    """World 엔드포인트"""
    return "world"

# API 엔드포인트 예시
@app.get("/api/info", response_class=JSONResponse)
async def api_info():
    """서버 정보 반환"""
    return {
        "server": "FastAPI",
        "python_version": os.sys.version,
        "environment": os.getenv("ENVIRONMENT", "production")
    }

# 정적 파일 서빙
static_dir = pathlib.Path(__file__).resolve().parent
public_dir = static_dir / "public"

if public_dir.exists():
app.mount("/images", StaticFiles(directory=public_dir, html=False), name="images")
    app.mount("/static", StaticFiles(directory=public_dir), name="static")

# 에러 핸들러
@app.exception_handler(404)
async def not_found_handler(request: Request, exc):
    return JSONResponse(
        status_code=404,
        content={"detail": "요청한 리소스를 찾을 수 없습니다."}
    )

@app.exception_handler(500)
async def internal_error_handler(request: Request, exc):
    return JSONResponse(
        status_code=500,
        content={"detail": "서버 내부 오류가 발생했습니다."}
    )

# 애플리케이션 시작/종료 이벤트
@app.on_event("startup")
async def startup_event():
    """앱 시작 시 실행"""
    print("FastAPI 서버 시작됨")

@app.on_event("shutdown")
async def shutdown_event():
    """앱 종료 시 실행"""
    print("FastAPI 서버 종료됨")

# 직접 실행 시 (개발 환경용)
if __name__ == "__main__":
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        log_level="info"
    )
```

### 파일 생성 방법

```bash
cd /home/ubuntu/reactbase
nano server.py
# 위 코드를 복사 붙여넣기
# Ctrl+O (저장), Ctrl+X (종료)
```

### 코드 주요 특징

**프로덕션 준비:**
- 헬스 체크 엔드포인트 (`/health`)
- CORS 미들웨어 설정
- 에러 핸들러 구현
- 시작/종료 이벤트 핸들러

**보안:**
- TrustedHostMiddleware 옵션 (필요 시 활성화)
- 환경 변수를 통한 설정 관리

**문서화:**
- Swagger UI (`/docs`)
- ReDoc (`/redoc`)

---

## 서버 실행 테스트

### 개발 모드로 서버 실행

가상환경 활성화 후 FastAPI 서버를 테스트 실행합니다:

```bash
cd /home/ubuntu/reactbase
source venv/bin/activate
python3 server.py
```

**또는 uvicorn 직접 실행:**

```bash
uvicorn server:app --host 0.0.0.0 --port 8000
```

**개발 모드 (자동 리로드 활성화):**

```bash
uvicorn server:app --host 0.0.0.0 --port 8000 --reload
```

### 정상 실행 확인

콘솔에 다음과 같은 로그가 출력되면 정상입니다:

```
INFO:     Started server process [12345]
INFO:     Waiting for application startup.
FastAPI 서버 시작됨
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
```

### 로컬에서 테스트

SSH 세션 내에서 curl로 테스트:

```bash
# 새 터미널 열기 (또는 서버를 백그라운드로 실행)
curl http://localhost:8000/
# 출력: Welcome to FastAPI Production Server

curl http://localhost:8000/health
# 출력: {"status":"healthy","timestamp":"...","version":"1.0.0"}
```

### 외부에서 접속 테스트

브라우저 또는 로컬 터미널에서:

```bash
http://인스턴스_퍼블릭IP:8000
http://인스턴스_퍼블릭IP:8000/docs  # Swagger UI
http://인스턴스_퍼블릭IP:8000/health
```

**접속이 안 된다면:**
1. AWS 보안 그룹에서 8000 포트가 열려있는지 확인
2. UFW 방화벽 확인 (설정한 경우)
3. 로컬 네트워크 방화벽 확인

### 서버 중지

```bash
# Ctrl+C로 중지
# 또는 프로세스 찾아서 종료
ps aux | grep uvicorn
kill <PID>
```

---

## AWS 보안 그룹 설정

AWS 보안 그룹은 EC2 인스턴스의 가상 방화벽 역할을 합니다. 외부에서 서버에 접근하려면 필요한 포트를 열어야 합니다.

### 보안 그룹 인바운드 규칙 설정

**AWS Console에서 설정:**

1. EC2 Dashboard → 인스턴스 선택
2. 보안 탭 → 보안 그룹 클릭
3. 인바운드 규칙 편집

**필수 규칙:**

| 유형 | 프로토콜 | 포트 범위 | 소스 | 설명 |
|------|---------|----------|------|------|
| SSH | TCP | 22 | My IP 또는 특정 IP | SSH 접속 |
| 사용자 지정 TCP | TCP | 8000 | 0.0.0.0/0 | FastAPI 직접 접근 (개발) |
| HTTP | TCP | 80 | 0.0.0.0/0 | Nginx HTTP |
| HTTPS | TCP | 443 | 0.0.0.0/0 | Nginx HTTPS |

**보안 권장사항:**

```
개발 단계: 8000 포트 개방 (0.0.0.0/0)
프로덕션 단계: 8000 포트 차단, 80/443만 개방
  → Nginx를 통해서만 FastAPI 접근 허용
```

### IP 화이트리스트 설정 (선택사항)

SSH 접근을 특정 IP로 제한:

```
유형: SSH
프로토콜: TCP
포트: 22
소스: 123.456.789.0/32 (귀하의 고정 IP)
설명: Office IP only
```

### 아웃바운드 규칙 확인

기본적으로 모든 아웃바운드 트래픽이 허용되어 있습니다. 보안 강화가 필요한 경우 다음만 허용:

| 유형 | 프로토콜 | 포트 범위 | 대상 | 설명 |
|------|---------|----------|------|------|
| HTTP | TCP | 80 | 0.0.0.0/0 | 패키지 다운로드 |
| HTTPS | TCP | 443 | 0.0.0.0/0 | 보안 통신 |
| DNS (UDP) | UDP | 53 | 0.0.0.0/0 | DNS 조회 |

### 최소 권한 원칙

프로덕션 환경에서는 다음 원칙을 따릅니다:

1. **SSH는 신뢰할 수 있는 IP만 허용**
2. **애플리케이션 포트(8000)는 로컬호스트만 접근** (Nginx 사용 시)
3. **80/443 포트만 인터넷에 개방**
4. **불필요한 포트는 모두 차단**

### CLI로 보안 그룹 설정

AWS CLI를 사용하는 경우:

```bash
# 보안 그룹 ID 확인
aws ec2 describe-security-groups

# 인바운드 규칙 추가 (포트 8000)
aws ec2 authorize-security-group-ingress \
    --group-id sg-xxxxxxxxx \
    --protocol tcp \
    --port 8000 \
    --cidr 0.0.0.0/0
```

---

## systemd를 통한 자동 실행 설정

systemd는 Linux 시스템의 서비스 관리자로, 프로세스의 시작, 중지, 재시작 및 자동 실행을 관리합니다.

### systemd 서비스 파일 생성

`/etc/systemd/system/fastapi.service` 파일을 생성합니다:

```bash
sudo nano /etc/systemd/system/fastapi.service
```

**기본 설정:**

```ini
[Unit]
Description=FastAPI Application Server
After=network.target
Documentation=https://fastapi.tiangolo.com/

[Service]
Type=notify
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/reactbase
Environment="PATH=/home/ubuntu/reactbase/venv/bin"
EnvironmentFile=-/home/ubuntu/reactbase/.env
ExecStart=/home/ubuntu/reactbase/venv/bin/uvicorn server:app --host 0.0.0.0 --port 8000
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=3
StandardOutput=append:/var/log/fastapi/access.log
StandardError=append:/var/log/fastapi/error.log

# 보안 설정
NoNewPrivileges=true
PrivateTmp=true

# 리소스 제한
LimitNOFILE=65536
TimeoutStopSec=30

[Install]
WantedBy=multi-user.target
```

**프로덕션 설정 (Multi-worker):**

```ini
[Unit]
Description=FastAPI Application Server (Production)
After=network.target
Documentation=https://fastapi.tiangolo.com/

[Service]
Type=notify
User=ubuntu
Group=ubuntu
WorkingDirectory=/home/ubuntu/reactbase
Environment="PATH=/home/ubuntu/reactbase/venv/bin"
EnvironmentFile=-/home/ubuntu/reactbase/.env
ExecStart=/home/ubuntu/reactbase/venv/bin/uvicorn server:app \
    --host 0.0.0.0 \
    --port 8000 \
    --workers 4 \
    --log-level info \
    --access-log \
    --proxy-headers \
    --forwarded-allow-ips='*'
ExecReload=/bin/kill -HUP $MAINPID
Restart=on-failure
RestartSec=5s
StandardOutput=journal
StandardError=journal
SyslogIdentifier=fastapi

# 보안 강화
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=read-only
ReadWritePaths=/home/ubuntu/reactbase

# 리소스 제한
LimitNOFILE=65536
LimitNPROC=512

[Install]
WantedBy=multi-user.target
```

### 서비스 파일 옵션 설명

**[Unit] 섹션:**
- `Description`: 서비스 설명
- `After`: 네트워크가 준비된 후 시작
- `Documentation`: 문서 URL

**[Service] 섹션:**
- `Type=notify`: systemd에 시작 완료 알림
- `User/Group`: 실행 사용자/그룹
- `WorkingDirectory`: 작업 디렉터리
- `Environment`: 환경 변수 설정
- `EnvironmentFile`: .env 파일 로드 (-는 파일 없어도 에러 안남)
- `ExecStart`: 실행 명령어
- `ExecReload`: 리로드 명령어 (HUP 시그널)
- `Restart=always`: 항상 재시작 (on-failure는 실패 시만)
- `RestartSec`: 재시작 대기 시간
- `StandardOutput/StandardError`: 로그 출력 위치

**보안 옵션:**
- `NoNewPrivileges`: 권한 상승 방지
- `PrivateTmp`: 독립적인 /tmp 사용
- `ProtectSystem`: 시스템 디렉터리 보호
- `ProtectHome`: 홈 디렉터리 보호

**리소스 제한:**
- `LimitNOFILE`: 파일 디스크립터 제한
- `LimitNPROC`: 프로세스 수 제한

### Worker 수 계산

CPU 코어 기반 권장 worker 수:

```bash
# CPU 코어 수 확인
nproc

# 권장 worker 수 = (CPU 코어 수 × 2) + 1
# 예: 2 코어 → (2 × 2) + 1 = 5 workers
```

### 로그 디렉터리 생성

StandardOutput/StandardError에 파일 로그를 사용하는 경우:

```bash
sudo mkdir -p /var/log/fastapi
sudo chown ubuntu:ubuntu /var/log/fastapi
sudo chmod 755 /var/log/fastapi
```

---

### systemd 서비스 등록 및 활성화

**서비스 등록 단계:**

```bash
# 1. systemd에 새 서비스 파일 인식
sudo systemctl daemon-reload

# 2. 부팅 시 자동 시작 활성화
sudo systemctl enable fastapi.service

# 3. 서비스 즉시 시작
sudo systemctl start fastapi.service

# 4. 서비스 상태 확인
sudo systemctl status fastapi.service
```

**정상 실행 시 출력:**

```
● fastapi.service - FastAPI Application Server
     Loaded: loaded (/etc/systemd/system/fastapi.service; enabled; vendor preset: enabled)
     Active: active (running) since Fri 2025-10-11 10:30:00 KST; 5s ago
       Docs: https://fastapi.tiangolo.com/
   Main PID: 12345 (uvicorn)
      Tasks: 5 (limit: 4915)
     Memory: 50.2M
     CGroup: /system.slice/fastapi.service
             ├─12345 /home/ubuntu/reactbase/venv/bin/python3 /home/ubuntu/reactbase/venv/bin/uvicorn...
             ├─12346 /home/ubuntu/reactbase/venv/bin/python3 -c from multiprocessing.resource_tracker...
             └─12347 /home/ubuntu/reactbase/venv/bin/python3 -c from multiprocessing.spawn import...

Oct 11 10:30:00 systemd[1]: Started FastAPI Application Server.
Oct 11 10:30:00 uvicorn[12345]: INFO:     Started server process [12345]
Oct 11 10:30:00 uvicorn[12345]: INFO:     Waiting for application startup.
Oct 11 10:30:00 uvicorn[12345]: INFO:     Application startup complete.
Oct 11 10:30:00 uvicorn[12345]: INFO:     Uvicorn running on http://0.0.0.0:8000
```

### systemd 서비스 관리 명령어

**상태 확인:**

```bash
# 서비스 상태
sudo systemctl status fastapi.service

# 실행 여부만 확인
sudo systemctl is-active fastapi.service

# 자동 시작 활성화 여부
sudo systemctl is-enabled fastapi.service
```

**서비스 제어:**

```bash
# 서비스 시작
sudo systemctl start fastapi.service

# 서비스 중지
sudo systemctl stop fastapi.service

# 서비스 재시작
sudo systemctl restart fastapi.service

# 서비스 리로드 (다운타임 없이)
sudo systemctl reload fastapi.service

# 부팅 시 자동 시작 활성화
sudo systemctl enable fastapi.service

# 부팅 시 자동 시작 비활성화
sudo systemctl disable fastapi.service
```

**서비스 파일 수정 후:**

```bash
# 서비스 파일 수정
sudo nano /etc/systemd/system/fastapi.service

# 변경사항 적용
sudo systemctl daemon-reload

# 서비스 재시작
sudo systemctl restart fastapi.service
```

### 서비스 의존성 확인

```bash
# 서비스 의존성 트리
systemctl list-dependencies fastapi.service

# 서비스 시작 순서
systemd-analyze critical-chain fastapi.service
```

---

### 재부팅 테스트

시스템 재부팅 후 자동 시작 확인:

```bash
# 재부팅
sudo reboot
```

재부팅 후 SSH 재접속 (약 1-2분 후):

```bash
ssh -i /경로/열쇠파일.pem ubuntu@인스턴스IP

# 서비스 상태 확인
sudo systemctl status fastapi.service

# 서비스가 자동 시작되었는지 확인
curl http://localhost:8000/health
```

---

## 환경 변수 관리

환경 변수를 사용하여 민감한 정보와 설정을 코드에서 분리합니다.

### .env 파일 생성

```bash
cd /home/ubuntu/reactbase
nano .env
```

**.env 파일 내용:**

```bash
# 환경 설정
ENVIRONMENT=production
DEBUG=False

# 서버 설정
HOST=0.0.0.0
PORT=8000
WORKERS=4

# 데이터베이스 (예시)
DATABASE_URL=postgresql://user:password@localhost/dbname

# API 키 (예시)
SECRET_KEY=your-secret-key-here-change-this
API_KEY=your-api-key-here

# CORS 설정
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com

# 로그 레벨
LOG_LEVEL=info
```

### .env 파일 권한 설정

민감한 정보 보호를 위해 권한 제한:

```bash
chmod 600 /home/ubuntu/reactbase/.env
chown ubuntu:ubuntu /home/ubuntu/reactbase/.env
```

### FastAPI 코드에서 환경 변수 사용

**server.py 수정:**

```python
import os
from dotenv import load_dotenv

load_dotenv()

# 환경 변수 읽기
ENVIRONMENT = os.getenv("ENVIRONMENT", "development")
DEBUG = os.getenv("DEBUG", "False") == "True"
SECRET_KEY = os.getenv("SECRET_KEY", "default-secret-key")
DATABASE_URL = os.getenv("DATABASE_URL")

app = FastAPI(
    title="FastAPI Server",
    debug=DEBUG
)

@app.get("/config")
async def get_config():
    return {
        "environment": ENVIRONMENT,
        "debug": DEBUG
        # SECRET_KEY는 노출하지 않음
    }
```

### systemd에서 환경 변수 사용

systemd 서비스 파일에서 .env 로드:

```ini
[Service]
EnvironmentFile=-/home/ubuntu/reactbase/.env
```

또는 직접 환경 변수 설정:

```ini
[Service]
Environment="ENVIRONMENT=production"
Environment="DEBUG=False"
Environment="PORT=8000"
```

### 환경 변수 보안 Best Practices

1. **.env 파일을 Git에 커밋하지 않기**
   ```bash
   echo ".env" >> .gitignore
   ```

2. **.env.example 파일 제공**
   ```bash
   cp .env .env.example
   # .env.example에서 실제 값 제거
   ```

3. **최소 권한 원칙**
   ```bash
   chmod 600 .env  # 소유자만 읽기/쓰기
   ```

4. **암호화된 값 저장 (선택사항)**
   - AWS Secrets Manager
   - HashiCorp Vault
   - 환경 변수 암호화 도구

---

## 로그 관리 및 디버깅

### journalctl을 사용한 로그 조회

systemd 서비스 로그는 journald에 저장됩니다.

**기본 로그 조회:**

```bash
# 전체 로그
sudo journalctl -u fastapi.service

# 최근 로그만 (tail)
sudo journalctl -u fastapi.service -n 50

# 실시간 로그 (follow)
sudo journalctl -u fastapi.service -f

# 오늘의 로그만
sudo journalctl -u fastapi.service --since today

# 특정 시간 이후
sudo journalctl -u fastapi.service --since "2025-10-11 10:00:00"

# 특정 시간 범위
sudo journalctl -u fastapi.service --since "1 hour ago" --until "now"
```

**로그 필터링:**

```bash
# 에러만 표시
sudo journalctl -u fastapi.service -p err

# 경고 이상 (warning, error, critical)
sudo journalctl -u fastapi.service -p warning

# 특정 문자열 검색
sudo journalctl -u fastapi.service | grep "ERROR"
```

**로그 형식 옵션:**

```bash
# JSON 형식
sudo journalctl -u fastapi.service -o json

# 자세한 정보
sudo journalctl -u fastapi.service -o verbose

# 한 줄로 표시
sudo journalctl -u fastapi.service -o short
```

### 로그 레벨 설정

**Uvicorn 로그 레벨:**

```bash
# systemd 서비스 파일에서
ExecStart=/home/ubuntu/reactbase/venv/bin/uvicorn server:app \
    --log-level debug  # debug, info, warning, error, critical
```

**Python logging 설정:**

```python
import logging

# 로그 설정
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/fastapi/app.log'),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger(__name__)

@app.get("/test")
async def test():
    logger.info("Test endpoint called")
    logger.debug("Debug information")
    logger.warning("Warning message")
    logger.error("Error occurred")
    return {"status": "ok"}
```

### 로그 로테이션

journald는 자동으로 로그를 로테이션하지만, 파일 로그를 사용하는 경우 logrotate 설정:

```bash
sudo nano /etc/logrotate.d/fastapi
```

**logrotate 설정:**

```
/var/log/fastapi/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 ubuntu ubuntu
    sharedscripts
    postrotate
        systemctl reload fastapi.service > /dev/null 2>&1 || true
    endscript
}
```

**옵션 설명:**
- `daily`: 매일 로테이션
- `rotate 14`: 14개 백업 유지
- `compress`: 압축 저장
- `delaycompress`: 다음 로테이션 때 압축
- `notifempty`: 빈 로그 파일 무시
- `create`: 새 로그 파일 권한

**로테이션 테스트:**

```bash
sudo logrotate -f /etc/logrotate.d/fastapi
```

### 일반적인 오류 패턴 및 해결

**1. 포트 이미 사용 중:**

```
ERROR: [Errno 98] Address already in use
```

해결:

```bash
# 8000 포트 사용 중인 프로세스 찾기
sudo lsof -i :8000
sudo netstat -tulpn | grep :8000

# 프로세스 종료
sudo kill -9 <PID>
```

**2. Permission denied:**

```
PermissionError: [Errno 13] Permission denied
```

해결:

```bash
# 파일/디렉터리 권한 확인
ls -la /home/ubuntu/reactbase

# 권한 수정
sudo chown -R ubuntu:ubuntu /home/ubuntu/reactbase
chmod 755 /home/ubuntu/reactbase
```

**3. ModuleNotFoundError:**

```
ModuleNotFoundError: No module named 'fastapi'
```

해결:

```bash
# 가상환경 활성화 확인
source /home/ubuntu/reactbase/venv/bin/activate

# 패키지 재설치
pip install fastapi uvicorn
```

**4. 서비스 시작 실패:**

```bash
# 상세 로그 확인
sudo journalctl -u fastapi.service -xe

# 서비스 파일 문법 확인
systemd-analyze verify /etc/systemd/system/fastapi.service
```

---

## Nginx 리버스 프록시 설정

Nginx를 리버스 프록시로 사용하면 정적 파일 서빙, SSL 종료, 로드 밸런싱, 보안 향상 등의 이점을 얻을 수 있습니다.

### Nginx 설치

```bash
sudo apt update
sudo apt install -y nginx
```

**Nginx 버전 확인:**

```bash
nginx -v
# 출력: nginx version: nginx/1.24.0 (Ubuntu)
```

**Nginx 서비스 시작:**

```bash
sudo systemctl start nginx
sudo systemctl enable nginx
sudo systemctl status nginx
```

### Nginx 설정 파일 생성

FastAPI 애플리케이션을 위한 Nginx 설정:

```bash
sudo nano /etc/nginx/sites-available/fastapi
```

**기본 설정 (HTTP):**

```nginx
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;  # 또는 IP 주소
    
    client_max_body_size 50M;  # 최대 요청 크기
    
    # 액세스 로그
    access_log /var/log/nginx/fastapi_access.log;
    error_log /var/log/nginx/fastapi_error.log;
    
    # FastAPI 프록시
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 지원
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 정적 파일 직접 서빙 (성능 향상)
    location /static/ {
        alias /home/ubuntu/reactbase/public/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    location /images/ {
        alias /home/ubuntu/reactbase/public/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

### Nginx 설정 활성화

```bash
# 심볼릭 링크 생성
sudo ln -s /etc/nginx/sites-available/fastapi /etc/nginx/sites-enabled/

# 기본 사이트 비활성화 (선택사항)
sudo rm /etc/nginx/sites-enabled/default

# 설정 문법 확인
sudo nginx -t

# Nginx 재시작
sudo systemctl reload nginx
```

### Nginx 고급 설정

**Gzip 압축 활성화:**

`/etc/nginx/nginx.conf` 편집:

```nginx
http {
    # Gzip 설정
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";
}
```

**Rate Limiting (속도 제한):**

```nginx
# /etc/nginx/sites-available/fastapi
http {
    # Rate limit 존 정의
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    
    server {
        # ... 기존 설정 ...
        
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://127.0.0.1:8000;
            # ... 프록시 설정 ...
        }
    }
}
```

**보안 헤더 추가:**

```nginx
server {
    # ... 기존 설정 ...
    
    # 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
}
```

### systemd 설정 수정

Nginx를 사용하는 경우, FastAPI는 로컬호스트에서만 수신:

```bash
sudo nano /etc/systemd/system/fastapi.service
```

**ExecStart 수정:**

```ini
ExecStart=/home/ubuntu/reactbase/venv/bin/uvicorn server:app \
    --host 127.0.0.1 \  # 127.0.0.1로 변경 (0.0.0.0에서)
    --port 8000 \
    --workers 4
```

**서비스 재시작:**

```bash
sudo systemctl daemon-reload
sudo systemctl restart fastapi.service
```

---

## HTTPS 설정 (Let's Encrypt)

Let's Encrypt를 사용하여 무료 SSL/TLS 인증서를 발급받고 HTTPS를 설정합니다.

### 사전 요구사항

- 도메인 이름 (DNS A 레코드가 EC2 IP를 가리켜야 함)
- 80, 443 포트가 보안 그룹에서 열려 있어야 함

### Certbot 설치

```bash
sudo apt update
sudo apt install -y certbot python3-certbot-nginx
```

### SSL 인증서 발급

**자동 설정 (권장):**

```bash
sudo certbot --nginx -d your-domain.com -d www.your-domain.com
```

**프롬프트 응답:**
1. 이메일 주소 입력 (인증서 만료 알림용)
2. 이용 약관 동의 (Y)
3. HTTPS로 리다이렉트 (권장: 2)

**수동 설정:**

```bash
# 인증서만 발급 (Nginx 설정은 수동)
sudo certbot certonly --nginx -d your-domain.com -d www.your-domain.com
```

### Nginx HTTPS 설정

Certbot이 자동으로 설정하지만, 수동 설정이 필요한 경우:

```bash
sudo nano /etc/nginx/sites-available/fastapi
```

**HTTPS 설정:**

```nginx
# HTTP → HTTPS 리다이렉트
server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com www.your-domain.com;
    
    return 301 https://$host$request_uri;
}

# HTTPS 서버
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL 인증서
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/your-domain.com/chain.pem;
    
    # SSL 설정 (Mozilla Intermediate 기준)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # SSL 세션 캐시
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # HSTS (HTTP Strict Transport Security)
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # 나머지 설정 (프록시, 정적 파일 등)
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    location /static/ {
        alias /home/ubuntu/reactbase/public/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

**설정 적용:**

```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 인증서 자동 갱신

Let's Encrypt 인증서는 90일마다 갱신이 필요합니다.

**자동 갱신 테스트:**

```bash
sudo certbot renew --dry-run
```

**자동 갱신 확인:**

Certbot은 systemd 타이머로 자동 갱신이 설정됩니다:

```bash
# 타이머 상태 확인
sudo systemctl status certbot.timer

# 갱신 스케줄 확인
sudo systemctl list-timers | grep certbot
```

**수동 갱신:**

```bash
sudo certbot renew
sudo systemctl reload nginx
```

### SSL 등급 테스트

[SSL Labs](https://www.ssllabs.com/ssltest/)에서 SSL 설정을 테스트하여 A+ 등급을 목표로 합니다.

---

## 보안 강화

### UFW 방화벽 설정

UFW(Uncomplicated Firewall)로 호스트 기반 방화벽을 설정합니다.

**UFW 설치 및 활성화:**

```bash
# 기본 정책 설정
sudo ufw default deny incoming
sudo ufw default allow outgoing

# SSH 허용 (연결 끊김 방지)
sudo ufw allow 22/tcp
# 또는 특정 IP만
sudo ufw allow from YOUR_IP_ADDRESS to any port 22

# HTTP/HTTPS 허용
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# UFW 활성화
sudo ufw enable

# 상태 확인
sudo ufw status verbose
```

**8000 포트 차단 (프로덕션):**

Nginx를 사용하는 경우 FastAPI 포트를 외부에 노출하지 않습니다:

```bash
# 8000 포트는 로컬호스트에서만 접근 가능
# UFW 규칙에 8000 포트 추가하지 않음
```

### Fail2ban 설정

SSH 무차별 대입 공격(Brute Force)을 방어합니다.

**Fail2ban 설치:**

```bash
sudo apt install -y fail2ban
```

**설정 파일 생성:**

```bash
sudo nano /etc/fail2ban/jail.local
```

**jail.local 내용:**

```ini
[DEFAULT]
bantime = 3600  # 1시간 차단
findtime = 600  # 10분 내
maxretry = 5    # 5회 시도 실패 시 차단

# SSH 보호
[sshd]
enabled = true
port = 22
logpath = /var/log/auth.log

# Nginx 보호 (선택사항)
[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log

[nginx-limit-req]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
```

**Fail2ban 시작:**

```bash
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
sudo systemctl status fail2ban
```

**차단 상태 확인:**

```bash
# 차단된 IP 확인
sudo fail2ban-client status sshd

# 차단 해제
sudo fail2ban-client set sshd unbanip <IP_ADDRESS>
```

### SSH 보안 강화

**SSH 설정 변경:**

```bash
sudo nano /etc/ssh/sshd_config
```

**권장 설정:**

```
# 루트 로그인 비활성화
PermitRootLogin no

# 패스워드 인증 비활성화 (키 기반만 허용)
PasswordAuthentication no
PubkeyAuthentication yes

# 빈 패스워드 금지
PermitEmptyPasswords no

# X11 포워딩 비활성화 (필요없으면)
X11Forwarding no

# 접속 시도 제한
MaxAuthTries 3
MaxSessions 2

# 특정 사용자만 허용
AllowUsers ubuntu
```

**SSH 재시작:**

```bash
sudo systemctl restart sshd
```

### 자동 보안 업데이트

**Unattended-upgrades 설치:**

```bash
sudo apt install -y unattended-upgrades
```

**설정:**

```bash
sudo dpkg-reconfigure -plow unattended-upgrades
# "Yes" 선택
```

**설정 파일 확인:**

```bash
sudo nano /etc/apt/apt.conf.d/50unattended-upgrades
```

**보안 업데이트만 자동 설치:**

```
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}-security";
};
```

---

## 성능 최적화

### Uvicorn Worker 최적화

**Worker 수 설정:**

```ini
# /etc/systemd/system/fastapi.service
ExecStart=/home/ubuntu/reactbase/venv/bin/uvicorn server:app \
    --host 127.0.0.1 \
    --port 8000 \
    --workers 4  # CPU 코어 수 * 2 + 1
```

**Worker 클래스 선택:**

기본 Uvicorn worker는 단일 스레드입니다. 높은 동시성이 필요한 경우:

```bash
pip install gunicorn
```

```ini
# Gunicorn + Uvicorn workers
ExecStart=/home/ubuntu/reactbase/venv/bin/gunicorn server:app \
    --workers 4 \
    --worker-class uvicorn.workers.UvicornWorker \
    --bind 127.0.0.1:8000 \
    --access-logfile /var/log/fastapi/access.log \
    --error-logfile /var/log/fastapi/error.log
```

### 데이터베이스 연결 풀링

데이터베이스를 사용하는 경우 연결 풀을 사용합니다:

```python
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=10,
    max_overflow=20,
    pool_pre_ping=True  # 연결 유효성 검사
)
```

### 캐싱 전략

**Redis 캐싱 예시:**

```bash
# Redis 설치
sudo apt install -y redis-server
sudo systemctl enable redis-server
```

```python
from redis import Redis
from fastapi import FastAPI

app = FastAPI()
redis_client = Redis(host='localhost', port=6379, db=0, decode_responses=True)

@app.get("/cached-data")
async def get_cached_data():
    # 캐시 확인
    cached = redis_client.get("data_key")
    if cached:
        return {"data": cached, "source": "cache"}
    
    # 데이터 조회 및 캐싱
    data = expensive_operation()
    redis_client.setex("data_key", 3600, data)  # 1시간 TTL
    return {"data": data, "source": "database"}
```

### 정적 파일 최적화

**Nginx에서 직접 서빙:**

이미 위에서 설정한 것처럼 Nginx가 정적 파일을 직접 제공합니다.

**Gzip 압축:**

이미 Nginx에서 설정되었습니다.

### 메모리 및 CPU 모니터링

**시스템 리소스 확인:**

```bash
# CPU 및 메모리 사용량
htop
# 또는
top

# 프로세스별 메모리
ps aux --sort=-%mem | head -10

# 디스크 사용량
df -h

# 네트워크 연결
netstat -tulpn
```

---

## 모니터링 및 유지보수

### 시스템 모니터링 도구

**htop 설치:**

```bash
sudo apt install -y htop
htop
```

**Prometheus + Grafana (고급):**

프로덕션 환경에서 권장하는 모니터링 스택:

```bash
# Prometheus 설치
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xvfz prometheus-*.tar.gz
cd prometheus-*

# 설정 파일 작성
nano prometheus.yml
```

**prometheus.yml:**

```yaml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'fastapi'
    static_configs:
      - targets: ['localhost:8000']
```

### 애플리케이션 헬스 체크

**헬스 체크 엔드포인트 활용:**

```bash
# 주기적으로 헬스 체크
watch -n 5 curl -s http://localhost:8000/health
```

**Cron 작업으로 자동 모니터링:**

```bash
crontab -e
```

```cron
# 매 5분마다 헬스 체크
*/5 * * * * curl -sf http://localhost:8000/health || systemctl restart fastapi.service
```

### 디스크 공간 모니터링

```bash
# 디스크 사용량 확인
df -h

# 큰 디렉터리 찾기
du -h --max-depth=1 /home/ubuntu | sort -hr

# 로그 파일 크기 확인
du -sh /var/log/*
```

### 백업 전략

**데이터베이스 백업 (예시):**

```bash
# PostgreSQL 백업
pg_dump dbname > backup_$(date +%Y%m%d).sql

# 백업 자동화 (cron)
0 2 * * * pg_dump dbname > /backup/db_$(date +\%Y\%m\%d).sql
```

**애플리케이션 코드 백업:**

```bash
# Git을 사용한 버전 관리
cd /home/ubuntu/reactbase
git init
git add .
git commit -m "Initial commit"
git remote add origin <your-repo-url>
git push -u origin main
```

### 업데이트 및 배포 전략

**무중단 배포 (Blue-Green):**

```bash
# 새 버전 배포
cd /home/ubuntu/reactbase
git pull origin main

# 의존성 업데이트
source venv/bin/activate
pip install -r requirements.txt

# 서비스 재시작 (짧은 다운타임)
sudo systemctl restart fastapi.service
```

**Graceful Reload:**

```bash
# Gunicorn 사용 시
sudo systemctl reload fastapi.service
```

---

## VSCode SFTP 설정

VSCode를 사용하면 로컬에서 수정한 파일을 자동으로 EC2로 업로드할 수 있습니다.

### SFTP 익스텐션 설치

1. VSCode에서 Extensions 열기 (Ctrl+Shift+X)
2. "SFTP" 검색 (Natizyskunk.sftp)
3. 설치

### SFTP 설정 파일 생성

프로젝트 루트에 `.vscode/sftp.json` 파일 생성:

**Linux/macOS:**

```json
{
    "name": "AWS FastAPI Server",
    "host": "13.124.216.216",
    "protocol": "sftp",
    "port": 22,
    "username": "ubuntu",
    "remotePath": "/home/ubuntu/reactbase",
    "uploadOnSave": true,
    "downloadOnOpen": false,
    "ignore": [
        ".vscode",
        ".git",
        "venv",
        "__pycache__",
        "*.pyc",
        ".env"
    ],
    "privateKeyPath": "..."
}
```

**Windows:**

```json
{
    "name": "AWS FastAPI Server",
    "host": "13.124.216.216",
    "protocol": "sftp",
    "port": 22,
    "username": "ubuntu",
    "remotePath": "/home/ubuntu/reactbase",
    "uploadOnSave": true,
    "downloadOnOpen": false,
    "ignore": [
        ".vscode",
        ".git",
        "venv",
        "__pycache__",
        "*.pyc",
        ".env"
    ],
    "privateKeyPath": "C:\\Users\\my\\\pem\\my_proton_key.pem"
}
```

**중요 설정 옵션:**

- `uploadOnSave`: 파일 저장 시 자동 업로드
- `downloadOnOpen`: 파일 열 때 서버에서 다운로드
- `ignore`: 업로드 제외 파일/폴더
- `privateKeyPath`: Windows에서는 `\\\\` 사용 (이스케이프)

### SFTP 사용법

**파일 업로드:**

- 파일 저장 시 자동 업로드 (uploadOnSave: true)
- 수동 업로드: F1 → "SFTP: Upload" 선택

**폴더 동기화:**

```
F1 → "SFTP: Sync Local -> Remote"
F1 → "SFTP: Sync Remote -> Local"
```

**서버 파일 직접 편집:**

```
F1 → "SFTP: List"
파일 선택 → 편집
```

### 배포 후 서비스 재시작

파일 업로드 후 서버에서:

```bash
# SSH 접속
ssh aws-fastapi

# 서비스 재시작
sudo systemctl restart fastapi.service

# 로그 확인
sudo journalctl -u fastapi.service -f
```

---

## 트러블슈팅

### 포트 접속 불가 문제

**증상:**
브라우저에서 `http://인스턴스IP:8000` 접속 불가

**진단 단계:**

1. **서비스 실행 확인:**

```bash
sudo systemctl status fastapi.service
ps aux | grep uvicorn
```

2. **포트 리스닝 확인:**

```bash
sudo netstat -tulpn | grep :8000
# 또는
sudo ss -tulpn | grep :8000
```

3. **로컬호스트 접근 테스트:**

```bash
curl http://localhost:8000
curl http://127.0.0.1:8000
```

4. **AWS 보안 그룹 확인:**

EC2 Console → 보안 그룹 → 인바운드 규칙에 8000 포트 있는지 확인

5. **UFW 방화벽 확인:**

```bash
sudo ufw status
# 8000 포트가 허용되어 있는지 확인
```

6. **ISP 방화벽 문제:**

집 인터넷에서 안 되면 **휴대폰 핫스팟**으로 시도

**해결 방법:**

```bash
# 보안 그룹에 8000 포트 추가
# UFW 허용 (필요한 경우)
sudo ufw allow 8000/tcp

# 서비스 재시작
sudo systemctl restart fastapi.service
```

### systemd 서비스 실행 실패

**증상:**
`sudo systemctl start fastapi.service` 실패

**진단:**

```bash
# 상세 로그 확인
sudo journalctl -u fastapi.service -xe

# 서비스 파일 문법 확인
systemd-analyze verify /etc/systemd/system/fastapi.service

# 수동 실행 테스트
cd /home/ubuntu/reactbase
source venv/bin/activate
python3 server.py
```

**일반적인 원인:**

1. **가상환경 경로 오류:**

```ini
# 경로 확인
Environment="PATH=/home/ubuntu/reactbase/venv/bin"
ExecStart=/home/ubuntu/reactbase/venv/bin/uvicorn server:app
```

2. **파일 권한 문제:**

```bash
sudo chown -R ubuntu:ubuntu /home/ubuntu/reactbase
chmod 755 /home/ubuntu/reactbase
```

3. **모듈 누락:**

```bash
source venv/bin/activate
pip install fastapi uvicorn
```

### Permission Denied 오류

**증상:**
```
PermissionError: [Errno 13] Permission denied: '/some/path'
```

**해결:**

```bash
# 디렉터리 소유자 확인
ls -la /home/ubuntu/reactbase

# 소유자 변경
sudo chown -R ubuntu:ubuntu /home/ubuntu/reactbase

# 권한 설정
chmod 755 /home/ubuntu/reactbase
chmod 644 /home/ubuntu/reactbase/server.py
chmod 600 /home/ubuntu/reactbase/.env
```

### 메모리 부족 문제

**증상:**
서버가 자주 재시작되거나 응답이 느림

**진단:**

```bash
# 메모리 사용량 확인
free -h

# 프로세스별 메모리
ps aux --sort=-%mem | head -10

# OOM (Out of Memory) 로그 확인
dmesg | grep -i "out of memory"
sudo journalctl -k | grep -i "killed process"
```

**해결:**

1. **Worker 수 줄이기:**

```ini
# /etc/systemd/system/fastapi.service
ExecStart=/home/ubuntu/reactbase/venv/bin/uvicorn server:app \
    --workers 2  # 줄임
```

2. **스왑 메모리 추가:**

```bash
# 1GB 스왑 생성
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 영구 설정
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab

# 확인
free -h
```

3. **인스턴스 업그레이드:** t2.micro → t2.small

### 네트워크 타임아웃

**증상:**
요청이 느리거나 타임아웃

**해결:**

```nginx
# Nginx 타임아웃 증가
location / {
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;
}
```

```ini
# systemd 타임아웃
[Service]
TimeoutStartSec=120
TimeoutStopSec=120
```

### SFTP 연결 문제

**Windows에서 privateKeyPath 오류:**

```json
{
    "privateKeyPath": "C:\\Users\\my\\\pem\\my_proton_key.pem"
}
```

**키 권한 오류:**

```bash
# Linux/macOS
chmod 400 /path/to/key.pem

# Windows PowerShell
icacls "C:\path\to\key.pem" /inheritance:r
icacls "C:\path\to\key.pem" /grant:r "%USERNAME%:R"
```

**연결 테스트:**

```bash
# 터미널에서 SFTP 테스트
sftp -i /path/to/key.pem ubuntu@<IP>
```

---

## 참고 자료

### 공식 문서

**FastAPI:**
- [FastAPI 공식 문서](https://fastapi.tiangolo.com/)
- [FastAPI 배포 가이드](https://fastapi.tiangolo.com/deployment/)
- [Uvicorn 문서](https://www.uvicorn.org/)

**AWS:**
- [EC2 사용 설명서](https://docs.aws.amazon.com/ec2/)
- [보안 그룹 규칙](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)
- [Elastic IP 주소](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/elastic-ip-addresses-eip.html)

**Nginx:**
- [Nginx 공식 문서](https://nginx.org/en/docs/)
- [Nginx 리버스 프록시 가이드](https://docs.nginx.com/nginx/admin-guide/web-server/reverse-proxy/)

**Let's Encrypt:**
- [Certbot 문서](https://certbot.eff.org/)
- [Let's Encrypt 문서](https://letsencrypt.org/docs/)

**systemd:**
- [systemd 서비스 단위 파일](https://www.freedesktop.org/software/systemd/man/systemd.service.html)
- [systemd 예제](https://www.freedesktop.org/software/systemd/man/systemd.unit.html)

### 보안 Best Practices

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Mozilla SSL Configuration Generator](https://ssl-config.mozilla.org/)
- [CIS Ubuntu Benchmark](https://www.cisecurity.org/benchmark/ubuntu_linux)

### 성능 최적화

- [FastAPI 성능 팁](https://fastapi.tiangolo.com/advanced/performance/)
- [Uvicorn 프로덕션 배포](https://www.uvicorn.org/deployment/)
- [Nginx 성능 튜닝](https://www.nginx.com/blog/tuning-nginx/)

### 모니터링 도구

- [Prometheus](https://prometheus.io/)
- [Grafana](https://grafana.com/)
- [Netdata](https://www.netdata.cloud/)
- [CloudWatch (AWS)](https://aws.amazon.com/cloudwatch/)

### 커뮤니티

- [FastAPI GitHub](https://github.com/tiangolo/fastapi)
- [FastAPI Discord](https://discord.com/invite/VQjSZaeJmf)
- [Stack Overflow - FastAPI 태그](https://stackoverflow.com/questions/tagged/fastapi)

---

## 마무리

이 문서는 AWS EC2에서 FastAPI 애플리케이션을 프로덕션 수준으로 배포하는 완전한 가이드를 제공합니다.

**핵심 단계 요약:**

1. **인프라 설정**: EC2 인스턴스 생성 및 보안 그룹 구성
2. **애플리케이션 배포**: Python 환경 설정 및 FastAPI 설치
3. **프로세스 관리**: systemd를 통한 자동 실행 및 관리
4. **리버스 프록시**: Nginx를 통한 트래픽 라우팅 및 최적화
5. **보안 강화**: HTTPS, 방화벽, Fail2ban 설정
6. **성능 최적화**: Worker 설정, 캐싱, 리소스 모니터링
7. **지속적 관리**: 로그 관리, 백업, 업데이트 전략

**프로덕션 체크리스트:**

- [x] systemd 자동 실행 설정
- [x] Nginx 리버스 프록시 구성
- [x] HTTPS/SSL 인증서 설정
- [x] UFW 방화벽 활성화
- [x] Fail2ban SSH 보호
- [x] 로그 로테이션 설정
- [x] 헬스 체크 엔드포인트 구현
- [x] 모니터링 도구 설치
- [x] 백업 전략 수립
- [x] 자동 보안 업데이트 활성화

이제 여러분의 FastAPI 서버는 안정적이고 안전하며 확장 가능한 프로덕션 환경에서 실행됩니다.

**추가 개선 사항:**

- CI/CD 파이프라인 구축 (GitHub Actions, GitLab CI)
- 컨테이너화 (Docker, Docker Compose)
- 오케스트레이션 (Kubernetes, ECS)
- 로드 밸런서 구성 (Application Load Balancer)
- 데이터베이스 분리 (RDS, Aurora)
- CDN 활용 (CloudFront)
- 서버리스 옵션 (Lambda + API Gateway)

행운을 빕니다!
