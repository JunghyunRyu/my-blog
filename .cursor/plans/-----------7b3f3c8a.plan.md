<!-- 7b3f3c8a-ead8-4a4b-ac23-071c60b472b1 6a21b82c-69c3-4692-84c3-9d883ccef3a1 -->
# GeekNews 자동화 시스템 개선 계획

## 현재 문제점 분석

### 1. 웹 검색 기능 동작 불능

- `web_researcher.py`의 DuckDuckGo Instant Answer API가 deprecated됨
- 현재 코드: `api.duckduckgo.com` 사용 (더 이상 작동하지 않음)
- 해결책: `duckduckgo-search` 라이브러리 사용 (이미 requirements.txt에 포함됨)

### 2. MCP Sequential Thinking 미동작

- MCP 클라이언트는 구현되어 있지만 서버가 없음
- `http://localhost:3000`에 연결 시도하지만 서버 미실행
- 해결책: MCP Sequential Thinking 서버 설치 및 systemd 서비스로 등록

### 3. 코드 품질 개선 필요

- `urllib.request` 사용 (오래된 방식, 에러 처리 복잡)
- OpenAI 공식 SDK 미사용 (수동 HTTP 호출)
- 에러 처리 미흡
- 해결책: 단계적으로 현대적인 라이브러리로 전환

## 개선 계획 (우선순위 순)

### 1단계: 웹 검색 기능 즉시 복구 ⭐ 최우선

**목표**: `web_researcher.py`의 DuckDuckGo 검색 기능을 `duckduckgo-search` 라이브러리로 교체

**변경 파일**:

- `automation/web_researcher.py`

**주요 변경 사항**:

```python
# 기존: api.duckduckgo.com (deprecated)
# 신규: duckduckgo-search 라이브러리 사용

from duckduckgo_search import DDGS

def _search_web(self, query: str) -> list[WebResource]:
    with DDGS() as ddgs:
        results = ddgs.text(query, max_results=self.max_search_results)
        # 결과를 WebResource 형식으로 변환
```

**검증 방법**:

- 단독 테스트: `python -c "from automation.web_researcher import WebResearcher; ..."`
- 파이프라인 테스트: `python automation/geeknews_pipeline.py --max-posts 1`

---

### 2단계: MCP Sequential Thinking 서버 설정

**목표**: MCP 서버를 EC2 또는 로컬에 설치하고 systemd 서비스로 등록

**2-1. MCP 서버 설치 (Node.js 기반)**

MCP Sequential Thinking은 TypeScript/Node.js로 구현된 MCP 서버입니다. 설치 단계:

1. Node.js 설치 확인 (v18 이상 권장)
2. MCP Sequential Thinking 저장소 클론:
   ```bash
   git clone https://github.com/modelcontextprotocol/servers.git
   cd servers/src/sequentialthinking
   npm install
   npm run build
   ```

3. 환경 변수 설정 (`.env` 파일):
   ```
   ANTHROPIC_API_KEY=your_key_here
   PORT=3000
   ```


**2-2. Systemd 서비스 등록**

기존 `deploy/systemd/mcp-sequentialthinking.service` 파일을 활용:

- 서비스 파일 복사: `/etc/systemd/system/`
- 권한 설정 및 활성화
- 로그 확인: `journalctl -u mcp-sequentialthinking -f`

**2-3. Python 클라이언트 헬스체크**

`automation/mcp_client.py`의 `health_check()` 함수로 연결 확인:

```python
from automation.mcp_client import create_mcp_client
client = create_mcp_client()
if client:
    print("✓ MCP 연결 성공")
```

---

### 3단계: 코드 리팩토링 (단계적)

**목표**: 버그 수정 후 점진적으로 코드 품질 개선

**3-1. 에러 처리 개선 (즉시)**

주요 변경점:

- `qa_generator.py`: OpenAI API 호출 시 타임아웃 및 재시도 로직 추가
- `geeknews_pipeline.py`: RSS 피드 파싱 실패 시 fallback 추가
- `web_researcher.py`: 웹 검색 실패 시 빈 결과 반환 (크래시 방지)

**3-2. urllib → requests 마이그레이션 (선택적)**

현재 `urllib.request` 사용 중이나, `requests` 라이브러리가 더 간결하고 에러 처리가 우수함:

```python
# 기존
request = urllib.request.Request(url, headers={...})
with urllib.request.urlopen(request, timeout=10) as response:
    data = json.loads(response.read())

# 개선
import requests
response = requests.get(url, headers={...}, timeout=10)
data = response.json()
```

**3-3. OpenAI 공식 SDK 마이그레이션 (장기)**

현재 수동으로 HTTP 요청을 보내고 있으나, 공식 SDK가 더 안정적:

```python
# 기존: qa_generator.py의 urllib.request 사용
# 신규: openai 라이브러리 사용
from openai import OpenAI
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
response = client.chat.completions.create(...)
```

**우선순위**:

1. 에러 처리 개선 (즉시)
2. urllib → requests (선택적, 1-2주 내)
3. OpenAI SDK (장기, 1-2개월 내)

---

## 구현 순서

### Phase 1: 즉시 수정 (1-2일)

1. 웹 검색 기능 복구 (`web_researcher.py`)
2. 에러 처리 개선 (모든 모듈)
3. 테스트 및 검증

### Phase 2: MCP 설정 (3-5일)

1. MCP 서버 설치 (Node.js 환경)
2. Systemd 서비스 등록
3. Python 클라이언트 연결 테스트

### Phase 3: 점진적 리팩토링 (1-2주)

1. urllib → requests 마이그레이션
2. 코드 문서화 개선
3. 유닛 테스트 추가

### Phase 4: OpenAI SDK 마이그레이션 (선택적, 장기)

1. `qa_generator.py`의 OpenAI 호출 부분을 공식 SDK로 교체
2. 전체 파이프라인 재테스트

---

## 성공 기준

✅ 웹 검색 기능이 정상 작동하여 외부 자료 수집

✅ MCP 서버가 실행되고 Python 클라이언트가 연결 성공

✅ 파이프라인이 에러 없이 완료 (최소 5개 포스트 생성)

✅ 로그에 경고 메시지 감소

---

## 주의사항

- **Windows 환경**: PowerShell 명령어 사용, MCP 서버는 WSL 또는 별도 Linux 서버 권장
- **API 키**: OpenAI API 키 (필수), Anthropic API 키 (MCP용, 선택)
- **백업**: 수정 전 현재 작동하는 부분 백업
- **단계적 적용**: 각 단계별로 테스트 후 다음 단계 진행

### To-dos

- [ ] web_researcher.py의 DuckDuckGo 검색을 duckduckgo-search 라이브러리로 교체
- [ ] 모든 모듈에 에러 처리 로직 추가 (타임아웃, 재시도, fallback)
- [ ] 웹 검색 기능 복구 후 전체 파이프라인 테스트
- [ ] MCP Sequential Thinking 서버 설치 (Node.js 환경)
- [ ] MCP 서버를 systemd 서비스로 등록 및 자동 시작 설정
- [ ] Python MCP 클라이언트로 연결 테스트 및 헬스체크
- [ ] urllib.request를 requests 라이브러리로 점진적 마이그레이션
- [ ] qa_generator.py의 OpenAI API 호출을 공식 SDK로 마이그레이션